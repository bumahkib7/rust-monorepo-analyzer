name: RMA Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      path:
        description: Path to scan
        type: string
        default: "."
      severity:
        description: Minimum severity (info, warning, error, critical)
        type: string
        default: warning
      profile:
        description: Analysis profile (fast, balanced, strict)
        type: string
        default: balanced
      ruleset:
        description: Ruleset to use (security, maintainability)
        type: string
        default: ""
      upload-sarif:
        description: Upload SARIF to GitHub Security tab
        type: boolean
        default: true
      fail-on-findings:
        description: Fail if findings detected
        type: boolean
        default: false
      version:
        description: RMA version
        type: string
        default: latest
    outputs:
      findings-count:
        description: Number of findings
        value: ${{ jobs.scan.outputs.findings-count }}

jobs:
  scan:
    name: RMA Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    outputs:
      findings-count: ${{ steps.rma.outputs.findings-count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run RMA Scan
        id: rma
        uses: bumahkib7/rust-monorepo-analyzer/.github/actions/rma-scan@master
        with:
          path: ${{ inputs.path }}
          severity: ${{ inputs.severity }}
          profile: ${{ inputs.profile }}
          ruleset: ${{ inputs.ruleset }}
          upload-sarif: ${{ inputs.upload-sarif }}
          fail-on-findings: ${{ inputs.fail-on-findings }}
          version: ${{ inputs.version }}
      
      - name: Summary
        run: |
          echo "## RMA Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Findings:** ${{ steps.rma.outputs.findings-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ inputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path:** ${{ inputs.path }}" >> $GITHUB_STEP_SUMMARY
